machine:
  services:
    - docker
  post:
    - wget -qO- get.nextflow.io | bash ; chmod 755 nextflow ; sudo ln -s ~/nextflow /usr/local/bin/
    - git clone --depth=1 https://github.com/mfoll/NGS_data_test.git
    - mkdir -p ~/NGS_data_test/1000G_CEU_TP53/results/$CIRCLE_BRANCH
test:
  override:
    - |
      cd ~/NGS_data_test/1000G_CEU_TP53/
      nextflow run mfoll/robust-regression-caller -r $CIRCLE_BRANCH -with-docker mfoll/robust-regression-caller --bed TP53_all.bed --nsplit 4 --fasta_ref 17.fasta.gz --bam_folder BAM/ --min_dp 50 
      cp BAM/all_variants.vcf results/$CIRCLE_BRANCH/test1.vcf 
      rm -rf work/ .nextflow.* BAM/all_variants.vcf BAM/VCF/ BAM/PILEUP/ BAM/BED_REGIONS/ 
    - |
      cd ~/NGS_data_test/1000G_CEU_TP53/
      nextflow run mfoll/robust-regression-caller -r $CIRCLE_BRANCH -with-docker mfoll/robust-regression-caller --bed TP53_exon2_11.bed --nsplit 4 --fasta_ref 17.fasta.gz --bam_folder BAM/ --min_dp 50 
      cp BAM/all_variants.vcf results/$CIRCLE_BRANCH/test2.vcf 
      rm -rf work/ .nextflow.* BAM/all_variants.vcf BAM/VCF/ BAM/PILEUP/ BAM/BED_REGIONS/ 
    - |
      cd ~/NGS_data_test/1000G_CEU_TP53/
      nextflow run mfoll/robust-regression-caller -r $CIRCLE_BRANCH -with-docker mfoll/robust-regression-caller:stable --bed TP53_all.bed --nsplit 4 --fasta_ref 17.fasta.gz --bam_folder BAM/ --min_dp 50 
      cp BAM/all_variants.vcf results/$CIRCLE_BRANCH/test1_stable.vcf 
      rm -rf work/ .nextflow.* BAM/all_variants.vcf BAM/VCF/ BAM/PILEUP/ BAM/BED_REGIONS/ 
    - |
      cd ~/NGS_data_test/1000G_CEU_TP53/
      nextflow run mfoll/robust-regression-caller -r $CIRCLE_BRANCH -with-docker mfoll/robust-regression-caller:stable --bed TP53_exon2_11.bed --nsplit 4 --fasta_ref 17.fasta.gz --bam_folder BAM/ --min_dp 50 
      cp BAM/all_variants.vcf results/$CIRCLE_BRANCH/test2_stable.vcf 
      rm -rf work/ .nextflow.* BAM/all_variants.vcf BAM/VCF/ BAM/PILEUP/ BAM/BED_REGIONS/ 
deployment:
  git:
    branch: [master, dev]
    commands:
      - cd ~/NGS_data_test ; git config --global user.email "follm@iarc.fr"
      - cd ~/NGS_data_test ; git config --global user.name "Circle CI_$CIRCLE_PROJECT_REPONAME_$CIRCLE_BRANCH"
      - cd ~/NGS_data_test ; git add .
      - cd ~/NGS_data_test ; git status
      - cd ~/NGS_data_test ; git commit --allow-empty -m "Results from $CIRCLE_PROJECT_REPONAME:$CIRCLE_BRANCH CircleCI tests build $CIRCLE_BUILD_NUM"
      - cd ~/NGS_data_test ; git push origin master
